{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ restaurante.nome }}{% endblock %}

{% block extra_head %}
<style>
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .checkout-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .item-carrinho {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .item-carrinho:last-child {
        border-bottom: none;
    }
    
    .item-info h6 {
        margin: 0;
        font-weight: 600;
        color: #333;
    }
    
    .item-preco {
        font-weight: 600;
        color: #e74c3c;
        font-size: 1.1rem;
    }
    
    .total-section {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .total-final {
        font-size: 1.4rem;
        font-weight: 700;
        border-top: 2px solid rgba(255,255,255,0.3);
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .btn-finalizar {
        /* Neuromarketing: Cores vibrantes - laranja intenso para urg√™ncia e apetite */
        background: linear-gradient(135deg, #ff6600 0%, #ff8c00 50%, #ffa500 100%) !important;
        border: 3px solid #ff6600 !important;
        color: white !important;
        padding: 20px 40px !important;
        border-radius: 25px !important;
        font-size: 1.3rem !important;
        font-weight: 800 !important;
        width: 100% !important;
        position: relative !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
        letter-spacing: 0.5px !important;
        overflow: hidden !important;
        
        /* Sombra laranja vibrante que cria profundidade intensa */
        box-shadow: 0 12px 35px rgba(255, 102, 0, 0.5), 
                    0 6px 20px rgba(255, 140, 0, 0.3),
                    0 3px 10px rgba(0, 0, 0, 0.15) !important;
        
        /* Transi√ß√£o suave para refor√ßar feedback visual */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        
        /* Anima√ß√£o sutil de pulsa√ß√£o para chamar aten√ß√£o */
        animation: pulse-gentle 3s ease-in-out infinite !important;
        
        /* Cursor que refor√ßa a a√ß√£o */
        cursor: pointer !important;
        
        /* Prevent double-tap zoom no mobile */
        touch-action: manipulation;
    }
    
    /* Efeito shimmer para tornar mais atrativo */
    .btn-finalizar::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255, 255, 255, 0.3), 
            transparent);
        transition: left 0.5s;
    }
    
    .btn-finalizar:hover::before {
        left: 100%;
    }
    
    .btn-finalizar:hover {
        /* Hover vermelho vibrante - m√°xima urg√™ncia e a√ß√£o */
        transform: translateY(-4px) scale(1.03) !important;
        box-shadow: 0 15px 40px rgba(220, 38, 38, 0.6), 
                    0 8px 25px rgba(239, 68, 68, 0.4),
                    0 0 30px rgba(248, 113, 113, 0.3) !important;
        color: white !important;
        border-color: #dc2626 !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4) !important;
        
        /* Gradiente vermelho intenso no hover */
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #f87171 100%) !important;
    }
    
    .btn-finalizar:active {
        /* Feedback t√°til no clique - vermelho mais sutil */
        transform: translateY(-1px) scale(0.99) !important;
        box-shadow: 0 8px 20px rgba(220, 38, 38, 0.5),
                    0 4px 10px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.1s ease !important;
    }
    
    .btn-finalizar:focus {
        outline: none !important;
        box-shadow: 0 0 0 4px rgba(255, 102, 0, 0.4),
                    0 12px 35px rgba(255, 102, 0, 0.5) !important;
    }
    
    .btn-finalizar:disabled {
        background: #6c757d;
        cursor: not-allowed;
        animation: none;
        box-shadow: none;
    }
    
    .btn-finalizar:disabled:hover {
        transform: none;
        background: #6c757d;
    }
    
    /* Anima√ß√£o vibrante de pulsa√ß√£o laranja */
    @keyframes pulse-gentle {
        0%, 100% {
            box-shadow: 0 12px 35px rgba(255, 102, 0, 0.5), 
                        0 6px 20px rgba(255, 140, 0, 0.3),
                        0 3px 10px rgba(0, 0, 0, 0.15);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 18px 45px rgba(255, 102, 0, 0.7), 
                        0 10px 30px rgba(255, 140, 0, 0.5),
                        0 0 40px rgba(255, 165, 0, 0.3);
            transform: scale(1.02);
        }
    }
    
    /* √çcone animado dentro do bot√£o */
    .btn-finalizar .btn-icon {
        display: inline-block;
        margin-left: 8px;
        transition: transform 0.3s ease;
    }
    
    .btn-finalizar:hover .btn-icon {
        transform: translateX(3px);
    }
    
    .loading-cep {
        display: none;
        color: #007bff;
        margin-top: 5px;
    }
    
    .cep-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .checkout-container {
            padding: 10px;
        }
        
        .item-carrinho {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        /* Bot√£o finalizar responsivo para mobile */
        .btn-finalizar {
            padding: 20px 30px;
            font-size: 1.3rem;
            position: sticky;
            bottom: 10px;
            z-index: 1040;
            margin: 20px 0;
            border-radius: 15px;
        }
        
        .btn-finalizar:hover {
            /* Reduzir transforma√ß√£o no mobile para melhor usabilidade */
            transform: translateY(-1px) scale(1.01);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="row">
        <!-- Coluna esquerda - Formul√°rio -->
        <div class="col-lg-8">
            <form method="post" id="checkout-form">
                <div id="frete-error-msg" class="cep-error" style="display:none;"></div>
                {% csrf_token %}
                
                <!-- Input hidden para carrinho -->
                <input type="hidden" name="carrinho_json" id="carrinho_json">
                <input type="hidden" id="restaurante_id" value="{{ restaurante.id }}">
                
                <!-- Dados Pessoais -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-person-circle me-2"></i>
                        Dados Pessoais
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome" class="form-label">Nome completo *</label>
                            <input type="text" class="form-control" name="nome" id="nome" required value="{% if user.is_authenticated %}{{ user.get_full_name|default:user.first_name|default:user.username }}{% endif %}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="celular" class="form-label">Celular *</label>
                            <input type="tel" class="form-control" name="celular" id="celular" 
                                   placeholder="(11) 99999-9999" required value="{% if user.is_authenticated %}{{ user.celular }}{% endif %}">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" name="email" id="email" 
                                   placeholder="seu@email.com" value="{% if user.is_authenticated %}{{ user.email }}{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- Tipo de Entrega -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-truck me-2"></i>
                        Tipo de Entrega
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_entrega" 
                                       id="delivery" value="delivery" checked>
                                <label class="form-check-label" for="delivery">
                                    <i class="bi bi-truck me-2"></i>
                                    Delivery - Taxa: <span id="taxa-delivery-label">R$ 0,00</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_entrega" 
                                       id="retirada" value="retirada">
                                <label class="form-check-label" for="retirada">
                                    <i class="bi bi-shop me-2"></i>
                                    Retirada no Local
                                    <small class="text-muted">Sem taxa de entrega</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo de Entrega -->
                <div class="checkout-section" id="endereco-section">
                    <h3 class="section-title">
                        <i class="bi bi-geo-alt me-2"></i>
                        Endere√ßo de Entrega
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cep" class="form-label">CEP *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="cep" id="cep" 
                                       placeholder="00000-000" maxlength="9" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.cep %}{{ enderecos_usuario.0.cep }}{% endif %}">
                                <button class="btn btn-outline-secondary" type="button" id="buscar-cep">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div class="loading-cep">üîÑ Buscando CEP...</div>
                            <div class="cep-error"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="logradouro" class="form-label">Logradouro *</label>
                            <input type="text" class="form-control" name="logradouro" id="logradouro" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.logradouro %}{{ enderecos_usuario.0.logradouro }}{% endif %}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="numero" class="form-label">N√∫mero *</label>
                            <input type="text" class="form-control" name="numero" id="numero" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.numero %}{{ enderecos_usuario.0.numero }}{% endif %}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" name="complemento" id="complemento" 
                                   placeholder="Apto, sala, etc." value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.complemento %}{{ enderecos_usuario.0.complemento }}{% endif %}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bairro" class="form-label">Bairro *</label>
                            <input type="text" class="form-control" name="bairro" id="bairro" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.bairro %}{{ enderecos_usuario.0.bairro }}{% endif %}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cidade" class="form-label">Cidade *</label>
                            <input type="text" class="form-control" name="cidade" id="cidade" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.cidade %}{{ enderecos_usuario.0.cidade }}{% endif %}">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="estado" class="form-label">Estado *</label>
                            <input type="text" class="form-control" name="estado" id="estado" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.estado %}{{ enderecos_usuario.0.estado }}{% endif %}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="ponto_referencia" class="form-label">Ponto de Refer√™ncia</label>
                            <input type="text" class="form-control" name="ponto_referencia" id="ponto_referencia" 
                                   placeholder="Ex: pr√≥ximo ao posto de gasolina" value="{% if user.is_authenticated and enderecos_usuario and enderecos_usuario.0.ponto_referencia %}{{ enderecos_usuario.0.ponto_referencia }}{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- Forma de Pagamento -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-credit-card me-2"></i>
                        Forma de Pagamento
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="forma_pagamento" 
                                       id="dinheiro" value="dinheiro" checked>
                                <label class="form-check-label" for="dinheiro">
                                    üíµ Dinheiro
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="forma_pagamento" 
                                       id="cartao_credito" value="cartao_credito">
                                <label class="form-check-label" for="cartao_credito">
                                    üí≥ Cart√£o de Cr√©dito
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="forma_pagamento" 
                                       id="cartao_debito" value="cartao_debito">
                                <label class="form-check-label" for="cartao_debito">
                                    üí≥ Cart√£o de D√©bito
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="forma_pagamento" 
                                       id="pix" value="pix">
                                <label class="form-check-label" for="pix">
                                    PHONE PIX
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campo para troco (s√≥ aparece se dinheiro for selecionado) -->
                    <div id="troco-section">
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="troco_para" class="form-label">Troco para quanto?</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           name="troco_para" id="troco_para" placeholder="0,00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-chat-text me-2"></i>
                        Observa√ß√µes
                    </h3>
                    
                    <div class="mb-3">
                        <textarea class="form-control" name="observacoes" id="observacoes" 
                                  rows="3" placeholder="Observa√ß√µes adicionais para o seu pedido..."></textarea>
                    </div>
                    
                    <!-- Bot√£o foi movido de volta para o resumo -->
                </div>
            </form>
        </div>

        <!-- Coluna direita - Resumo do Pedido -->
        <div class="col-lg-4">
            <div class="checkout-section">
                <h3 class="section-title">
                    <i class="bi bi-bag me-2"></i>
                    Resumo do Pedido
                </h3>
                
                <!-- Itens do carrinho -->
                <div id="resumo-itens">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
                
                <!-- Totais -->
                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal-value">R$ 0,00</span>
                    </div>
                    <div class="total-row">
                        <span>Taxa de Entrega:</span>
                        <span id="taxa-value">R$ 0,00</span>
                    </div>
                    <div class="total-row total-final">
                        <span>Total:</span>
                        <span id="total-final">R$ 0,00</span>
                    </div>
                </div>
                
                <!-- Bot√£o finalizar -->
                <button type="submit" form="checkout-form" class="btn-finalizar">
                    <i class="bi bi-bag-check-fill me-2"></i>
                    Confirmar Pedido Agora
                    <i class="bi bi-arrow-right btn-icon"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
console.log('DEBUG [DEBUG] Script do checkout iniciado');

// Fun√ß√£o para buscar CEP
function buscarCEP() {
    console.log('SEARCH [CEP] Fun√ß√£o buscarCEP chamada');
    const cepInput = document.getElementById('cep');
    const loadingEl = document.querySelector('.loading-cep');
    const errorEl = document.querySelector('.cep-error');
    if (!cepInput) {
        console.error('ERROR Campo CEP n√£o encontrado');
        return;
    }
    const cep = cepInput.value.replace(/\D/g, '');
    console.log('CEP limpo:', cep);
    if (cep.length !== 8) {
        console.warn('CEP inv√°lido');
        if (errorEl) errorEl.textContent = 'Digite um CEP v√°lido com 8 d√≠gitos';
        return;
    }
    // Mostrar loading
    if (loadingEl) loadingEl.style.display = 'block';
    if (errorEl) errorEl.innerHTML = '';
    console.log('üåê Fazendo requisi√ß√£o para ViaCEP...');
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => {
            console.log('SIGNAL Response recebido:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('PACKAGE Dados recebidos:', data);
            if (loadingEl) loadingEl.style.display = 'none';
            if (data.erro) {
                console.error('ERROR CEP n√£o encontrado');
                if (errorEl) errorEl.textContent = 'CEP n√£o encontrado';
                return;
            }
            // Preencher campos
            const logradouro = document.getElementById('logradouro');
            const bairro = document.getElementById('bairro');
            const cidade = document.getElementById('cidade');
            const estado = document.getElementById('estado');
            if (logradouro) logradouro.value = data.logradouro || '';
            if (bairro) bairro.value = data.bairro || '';
            if (cidade) cidade.value = data.localidade || '';
            if (estado) estado.value = data.uf || '';
            if (errorEl) errorEl.innerHTML = '<span style="color: green;">OK CEP encontrado com sucesso!</span>';
            // Focar no n√∫mero
            const numeroInput = document.getElementById('numero');
            if (numeroInput) numeroInput.focus();
            console.log('OK Campos preenchidos com sucesso!');
            // Chamar AJAX para calcular frete
            calcularFreteAjax(cep);
        })
        .catch(error => {
            console.error('ERROR Erro na requisi√ß√£o:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) errorEl.textContent = 'Erro ao buscar CEP: ' + error.message;
        });
}

// Fun√ß√£o AJAX para calcular frete
let freteCalculado = 0;
function calcularFreteAjax(cep_destino) {
    // Extrair slug do restaurante da URL
    const currentPath = window.location.pathname;
    const slugMatch = currentPath.match(/^\/([^\/]+)\//);
    
    if (!slugMatch) {
        console.warn('N√£o foi poss√≠vel identificar o restaurante para calcular frete');
        return;
    }
    
    const restauranteSlug = slugMatch[1];
    const restauranteId = document.getElementById('restaurante_id').value;
    
    // Limpar CEPs removendo h√≠fen e outros caracteres
    const cep_destino_limpo = cep_destino.replace(/\D/g, '');
    const cep_origem_limpo = '{{ restaurante.cep }}'.replace(/\D/g, '');
    
    console.log('üöö Calculando frete:', {
        cep_origem: cep_origem_limpo,
        cep_destino: cep_destino_limpo,
        restauranteSlug: restauranteSlug
    });
    
    const taxaEl = document.getElementById('taxa-value');
    const taxaDeliveryLabel = document.getElementById('taxa-delivery-label');
    const totalEl = document.getElementById('total-final');
    const subtotalEl = document.getElementById('subtotal-value');
    const freteErrorMsg = document.getElementById('frete-error-msg');
    let subtotal = 0;
    if (subtotalEl) {
        subtotal = parseFloat(subtotalEl.textContent.replace('R$', '').replace(',', '.')) || 0;
    }
    fetch('/' + restauranteSlug + '/calcular-frete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `cep_origem=${encodeURIComponent(cep_origem_limpo)}&cep_destino=${encodeURIComponent(cep_destino_limpo)}&restaurante_id=${encodeURIComponent(restauranteId)}`
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                console.error('Erro HTTP', response.status, ':', errorData);
                throw new Error(`HTTP ${response.status}: ${errorData.erro || errorData.erro_tecnico || 'Erro desconhecido'}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.frete !== undefined) {
            freteCalculado = parseFloat(data.frete);
            const freteFormatado = `R$ ${freteCalculado.toFixed(2).replace('.', ',')}`;
            if (taxaEl) taxaEl.textContent = freteFormatado;
            if (taxaDeliveryLabel) taxaDeliveryLabel.textContent = freteFormatado;
            if (totalEl) totalEl.textContent = `R$ ${(subtotal + freteCalculado).toFixed(2).replace('.', ',')}`;
            if (freteErrorMsg) {
                freteErrorMsg.style.display = 'none';
                freteErrorMsg.textContent = '';
            }
        } else if (data.erro) {
            freteCalculado = 0;
            if (freteErrorMsg) {
                freteErrorMsg.style.display = 'block';
                freteErrorMsg.textContent = data.erro;
            }
            if (taxaEl) taxaEl.textContent = 'R$ 0,00';
            if (taxaDeliveryLabel) taxaDeliveryLabel.textContent = 'R$ 0,00';
            if (totalEl) totalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        }
    })
    .catch(error => {
        freteCalculado = 0;
        console.error('Erro ao calcular frete:', error);
        if (freteErrorMsg) {
            freteErrorMsg.style.display = 'block';
            freteErrorMsg.textContent = 'Erro ao calcular o frete. Tente novamente.';
        }
        if (taxaEl) taxaEl.textContent = 'R$ 0,00';
        if (taxaDeliveryLabel) taxaDeliveryLabel.textContent = 'R$ 0,00';
        if (totalEl) totalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
    });
}

// Vari√°veis globais
let carrinhoData = [];
const subtotal = parseFloat('{{ total_carrinho|default:0 }}') || 0;
const taxaEntrega = parseFloat('{{ restaurante.taxa_entrega|default:0 }}') || 0;

// Fun√ß√£o para carregar dados do carrinho
function carregarCarrinho() {
    try {
        console.log('CART Carregando carrinho via API...');
        
        // Extrair slug do restaurante da URL
        const currentPath = window.location.pathname;
        const slugMatch = currentPath.match(/^\/([^\/]+)\//);
        
        if (!slugMatch) {
            console.warn('WARN N√£o foi poss√≠vel identificar o restaurante');
            carrinhoData = [];
            atualizarResumo();
            return;
        }
        
        const restauranteSlug = slugMatch[1];
        
        fetch('/' + restauranteSlug + '/carrinho/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Erro na resposta: ' + response.status);
        })
        .then(data => {
            console.log('PACKAGE Dados do carrinho recebidos:', data);
            carrinhoData = data.items || [];
            
            // Atualizar resumo
            atualizarResumo();
            
            // Preencher campo hidden para envio
            const carrinhoJson = JSON.stringify(carrinhoData);
            document.getElementById('carrinho_json').value = carrinhoJson;
            console.log('PACKAGE Campo carrinho_json preenchido:', carrinhoJson);
        })
        .catch(error => {
            console.error('ERROR Erro ao carregar carrinho:', error);
            carrinhoData = [];
            atualizarResumo();
        });
        
    } catch (error) {
        console.error('ERROR Erro ao carregar carrinho:', error);
    }
}

// Fun√ß√£o para atualizar resumo do pedido
function atualizarResumo() {
    const resumoItens = document.getElementById('resumo-itens');
    const subtotalEl = document.getElementById('subtotal-value');
    const taxaEl = document.getElementById('taxa-value');
    const totalEl = document.getElementById('total-final');
    
    if (!resumoItens) return;
    
    let html = '';
    let total = 0;
    
    if (carrinhoData.length === 0) {
        html = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-cart-x fs-1 mb-3 d-block"></i>
                <h6>Carrinho vazio</h6>
                <p class="small mb-0">Adicione produtos para continuar</p>
            </div>
        `;
    } else {
        carrinhoData.forEach(item => {
            // Usar preco_total do Django ou calcular se necess√°rio
            const subtotalItem = item.preco_total || (item.preco_unitario * item.quantidade);
            total += subtotalItem;
            
            // Personaliza√ß√µes
            let personalizacoesHtml = '';
            if (item.personalizacoes && item.personalizacoes.length > 0) {
                const personalizacoesList = item.personalizacoes.map(p => {
                    let texto = p.nome;
                    if (p.preco_adicional && p.preco_adicional > 0) {
                        texto += ` (+R$ ${p.preco_adicional.toFixed(2).replace('.', ',')})`;
                    }
                    return texto;
                }).join(', ');
                personalizacoesHtml = `<small class="text-primary d-block">${personalizacoesList}</small>`;
            }
            
            // Observa√ß√µes
            let observacoesHtml = '';
            if (item.observacoes && item.observacoes.trim()) {
                observacoesHtml = `<small class="text-muted d-block"><i class="bi bi-chat-dots me-1"></i>${item.observacoes}</small>`;
            }

            html += `
                <div class="item-carrinho d-flex justify-content-between align-items-start py-2 border-bottom">
                    <div class="item-info flex-grow-1">
                        <h6 class="mb-1">${item.meio_a_meio ? '1/2x ' : ''}${item.nome}</h6>
                        <small class="text-muted">${item.meio_a_meio ? '1/2' : item.quantidade}x R$ ${(item.preco_unitario || item.preco || 0).toFixed(2).replace('.', ',')}</small>
                        ${personalizacoesHtml}
                        ${observacoesHtml}
                    </div>
                    <div class="item-preco fw-bold ms-2">
                        R$ ${subtotalItem.toFixed(2).replace('.', ',')}
                    </div>
                </div>
            `;
        });
    }
    
    resumoItens.innerHTML = html;
    
    // Atualizar totais
    if (subtotalEl) subtotalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    
    // Taxa de entrega baseada no tipo selecionado
    const tipoDelivery = document.querySelector('input[name="tipo_entrega"]:checked');
    let taxa = 0;
    if (tipoDelivery && tipoDelivery.value === 'delivery') {
        taxa = freteCalculado;
    }
    if (taxaEl) taxaEl.textContent = `R$ ${taxa.toFixed(2).replace('.', ',')}`;
    if (totalEl) totalEl.textContent = `R$ ${(total + taxa).toFixed(2).replace('.', ',')}`;
    
    console.log('MONEY Resumo atualizado - Itens:', carrinhoData.length, 'Total:', total);
}

// Fun√ß√£o para controlar exibi√ß√£o do endere√ßo
function controlarEndereco() {
    const tipoSelecionado = document.querySelector('input[name="tipo_entrega"]:checked');
    const enderecoSection = document.getElementById('endereco-section');
    
    if (enderecoSection && tipoSelecionado) {
        if (tipoSelecionado.value === 'delivery') {
            enderecoSection.style.display = 'block';
            // Tornar campos obrigat√≥rios
            ['cep', 'logradouro', 'numero', 'bairro', 'cidade', 'estado'].forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = true;
            });
        } else {
            enderecoSection.style.display = 'none';
            // Remover obrigatoriedade
            ['cep', 'logradouro', 'numero', 'bairro', 'cidade', 'estado'].forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = false;
            });
        }
        atualizarResumo();
    }
}

// Fun√ß√£o para controlar campo de troco
function controlarTroco() {
    const formaSelecionada = document.querySelector('input[name="forma_pagamento"]:checked');
    const trocoSection = document.getElementById('troco-section');
    
    if (trocoSection && formaSelecionada) {
        trocoSection.style.display = formaSelecionada.value === 'dinheiro' ? 'block' : 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('ROCKET [INIT] DOM carregado, inicializando checkout...');
    
    // Adicionar listener global para erros JavaScript
    window.addEventListener('error', function(e) {
        console.error('üö® [JS ERROR] Erro JavaScript detectado:', e.error);
        console.error('üö® [JS ERROR] Mensagem:', e.message);
        console.error('üö® [JS ERROR] Arquivo:', e.filename);
        console.error('üö® [JS ERROR] Linha:', e.lineno);
    });
    
    // Carregar dados do carrinho
    carregarCarrinho();
    
    // Se ap√≥s 2 segundos o carrinho ainda estiver vazio, tentar novamente
    setTimeout(() => {
        if (carrinhoData.length === 0) {
            console.log('WARN Carrinho ainda vazio ap√≥s 2s, tentando recarregar...');
            carregarCarrinho();
        }
    }, 2000);
    
    // Buscar CEP
    const buscarBtn = document.getElementById('buscar-cep');
    const cepInput = document.getElementById('cep');
    
    if (buscarBtn) {
        buscarBtn.addEventListener('click', function() {
            console.log('üî¥ [CLICK] Bot√£o buscar CEP clicado!');
            buscarCEP();
        });
        console.log('OK Event listener adicionado ao bot√£o buscar CEP');
    }
    
    if (cepInput) {
        // M√°scara para CEP
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Buscar automaticamente ao sair do campo
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                console.log('SEARCH [AUTO] Buscando CEP automaticamente:', cep);
                buscarCEP();
            }
        });
        
        console.log('OK Event listeners adicionados ao campo CEP');
    }
    
    // M√°scara para celular
    const celularInput = document.getElementById('celular');
    if (celularInput) {
        celularInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                e.target.value = value;
            }
        });
    }
    
    // Controles de tipo de entrega
    const tipoEntregaInputs = document.querySelectorAll('input[name="tipo_entrega"]');
    tipoEntregaInputs.forEach(input => {
        input.addEventListener('change', controlarEndereco);
    });
    controlarEndereco(); // Inicializar
    
    // Controles de forma de pagamento
    const formaPagamentoInputs = document.querySelectorAll('input[name="forma_pagamento"]');
    formaPagamentoInputs.forEach(input => {
        input.addEventListener('change', controlarTroco);
    });
    controlarTroco(); // Inicializar
    
    // Valida√ß√£o do formul√°rio
    const checkoutForm = document.getElementById('checkout-form');
    console.log('üìã [FORM] Procurando formul√°rio checkout-form...');
    
    if (checkoutForm) {
        console.log('üìã [FORM] Formul√°rio encontrado:', checkoutForm);
        console.log('üìã [FORM] Formul√°rio HTML:', checkoutForm.outerHTML.substring(0, 200) + '...');
        checkoutForm.addEventListener('submit', function(e) {
            console.log('üöÄ [SUBMIT] Formul√°rio sendo enviado!');
            console.log('üöÄ [SUBMIT] Dados do carrinho:', carrinhoData);
            
            // Verificar valida√ß√£o HTML5
            if (!checkoutForm.checkValidity()) {
                console.log('‚ùå [ERROR] Formul√°rio falhou na valida√ß√£o HTML5');
                const invalidFields = checkoutForm.querySelectorAll(':invalid');
                console.log('‚ùå [ERROR] Campos inv√°lidos:', invalidFields);
                invalidFields.forEach(field => {
                    console.log('‚ùå [ERROR] Campo inv√°lido:', field.name, field.validationMessage);
                });
                // Deixar o navegador lidar com isso
                return;
            } else {
                console.log('‚úÖ [SUCCESS] Formul√°rio passou na valida√ß√£o HTML5');
            }
            
            // Validar carrinho n√£o vazio
            if (carrinhoData.length === 0) {
                console.log('‚ùå [ERROR] Carrinho vazio, impedindo envio');
                e.preventDefault();
                alert('Seu carrinho est√° vazio! Adicione alguns produtos antes de finalizar.');
                return;
            }
            
            // Verificar se carrinho_json foi preenchido
            const carrinhoJsonField = document.getElementById('carrinho_json');
            const carrinhoJsonValue = carrinhoJsonField ? carrinhoJsonField.value : 'CAMPO_NAO_ENCONTRADO';
            console.log('üîç [CHECK] Verificando carrinho_json antes do envio:', carrinhoJsonValue);
            
            if (!carrinhoJsonField) {
                console.log('‚ùå [ERROR] Campo carrinho_json n√£o encontrado no DOM');
                e.preventDefault();
                alert('Erro: campo carrinho_json n√£o encontrado. Recarregue a p√°gina e tente novamente.');
                return;
            }
            
            if (!carrinhoJsonValue || carrinhoJsonValue === '[]') {
                console.log('‚ùå [ERROR] carrinho_json vazio ou inv√°lido:', carrinhoJsonValue);
                e.preventDefault();
                alert('Erro: dados do carrinho n√£o foram carregados. Recarregue a p√°gina e tente novamente.');
                return;
            }
            
            // Validar CEP se delivery
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            console.log('üìç [CHECK] Tipo de entrega selecionado:', tipoEntrega ? tipoEntrega.value : 'nenhum');
            
            if (tipoEntrega && tipoEntrega.value === 'delivery') {
                const cepField = document.getElementById('cep');
                const cep = cepField ? cepField.value.replace(/\D/g, '') : '';
                console.log('üìç [CHECK] CEP informado:', cep);
                
                if (cep.length !== 8) {
                    console.log('‚ùå [ERROR] CEP inv√°lido:', cep);
                    e.preventDefault();
                    alert('Por favor, informe um CEP v√°lido para a entrega.');
                    if (cepField) cepField.focus();
                    return;
                }
            }
            
            // Validar troco
            const formaPagamento = document.querySelector('input[name="forma_pagamento"]:checked');
            console.log('üí≥ [CHECK] Forma de pagamento selecionada:', formaPagamento ? formaPagamento.value : 'nenhum');
            
            if (formaPagamento && formaPagamento.value === 'dinheiro') {
                const trocoInput = document.getElementById('troco_para');
                if (trocoInput && trocoInput.value) {
                    const trocoValue = parseFloat(trocoInput.value) || 0;
                    console.log('üí∞ [CHECK] Valor do troco informado:', trocoValue);
                    
                    // Usar preco_total ou calcular baseado na estrutura do Django
                    const totalPedido = carrinhoData.reduce((acc, item) => {
                        return acc + (item.preco_total || (item.preco_unitario || item.preco || 0) * item.quantidade);
                    }, 0);
                    const taxa = tipoEntrega && tipoEntrega.value === 'delivery' ? taxaEntrega : 0;
                    const total = totalPedido + taxa;
                    
                    console.log('üí∞ [CHECK] Total do pedido calculado:', total);
                    
                    if (trocoValue > 0 && trocoValue < total) {
                        console.log('‚ùå [ERROR] Troco menor que total do pedido');
                        e.preventDefault();
                        alert('O valor do troco deve ser maior que o total do pedido.');
                        trocoInput.focus();
                        return;
                    }
                }
            }
            
            // Gerar c√≥digo √∫nico do pedido ser√° feito no backend Django
            
            console.log('‚úÖ [SUCCESS] Formul√°rio validado, enviando...');
            console.log('üìã [DEBUG] Dados do carrinho a serem enviados:', carrinhoData);
            console.log('üìã [DEBUG] Campos preenchidos:');
            console.log('- Nome:', document.getElementById('nome') ? document.getElementById('nome').value : 'CAMPO_NAO_ENCONTRADO');
            console.log('- Celular:', document.getElementById('celular') ? document.getElementById('celular').value : 'CAMPO_NAO_ENCONTRADO');
            console.log('- Tipo entrega:', tipoEntrega ? tipoEntrega.value : 'nenhum');
            console.log('- Forma pagamento:', formaPagamento ? formaPagamento.value : 'nenhum');
            console.log('üöÄ [FINAL] Permitindo envio do formul√°rio (n√£o chamando preventDefault)...');
            
            // Ap√≥s envio bem-sucedido, limpar carrinho
            // (ser√° chamado quando a p√°gina for redirecionada ou recarregada)
        });
    } else {
        console.log('‚ùå [ERROR] Formul√°rio checkout-form N√ÉO encontrado!');
        console.log('‚ùå [DEBUG] Todos os formul√°rios da p√°gina:');
        const allForms = document.querySelectorAll('form');
        allForms.forEach((form, index) => {
            console.log(`‚ùå [DEBUG] Form ${index}:`, form.outerHTML.substring(0, 100) + '...');
        });
    }
    
    // Fun√ß√£o para limpar carrinho ap√≥s pedido
    function limparCarrinhoAposPedido() {
        const currentPath = window.location.pathname;
        const slugMatch = currentPath.match(/^\/([^\/]+)\//);
        
        if (!slugMatch) return;
        
        const restauranteSlug = slugMatch[1];
        
        fetch('/' + restauranteSlug + '/carrinho/limpar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('üßπ Carrinho limpo ap√≥s pedido');
                carrinhoData = [];
                atualizarResumo();
                // Atualizar contador de carrinho se existe
                if (window.atualizarContadorCarrinho) {
                    window.atualizarContadorCarrinho();
                }
            }
        })
        .catch(error => {
            console.error('WARN Erro ao limpar carrinho:', error);
        });
    }
    
    // Fun√ß√£o para obter cookie CSRF (mesma do carrinho-novo.js)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    console.log('‚úÖ [BUTTON] Bot√£o finalizar configurado como type="submit" - sem necessidade de JavaScript adicional');
    
    console.log('OK [INIT] Checkout inicializado com sucesso!');
});
</script>
{% endblock %}
