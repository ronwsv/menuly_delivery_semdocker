{% extends "base.html" %}
{% load static %}
{% load loja_extras %}

{% block title %}{{ produto.nome }} - {{ restaurante.nome }}{% endblock %}

{% block extra_head %}
<meta property="og:title" content="{{ produto.nome }} - {{ restaurante.nome }}">
<meta property="og:description" content="{{ produto.descricao }}">
{% if produto.imagem_principal %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ produto.imagem_principal.url }}">
{% endif %}

<style>
/* Estilo para bot√£o meio-a-meio */
#btn-meio-a-meio {
    transition: all 0.3s ease;
    border: 2px solid #ffc107;
}

#btn-meio-a-meio:hover {
    background-color: #ffc107;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
}

/* Estilo para bot√£o flutuante */
#continuar-comprando-btn button {
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
}

#continuar-comprando-btn button:hover {
    transform: scale(1.1);
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
    }
}

/* Anima√ß√£o para mostrar indicador meio-a-meio */
#meio-a-meio-ativo {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
 <!-- Breadcrumb -->
 <nav aria-label="breadcrumb" class="mb-4">
 <ol class="breadcrumb">
 <li class="breadcrumb-item"><a href="{% loja_url 'home' %}">In√≠cio</a></li>
 <li class="breadcrumb-item"><a href="{% loja_url 'cardapio' %}">Card√°pio</a></li>
 {% if produto.categoria %}
 <li class="breadcrumb-item">
 <a href="{% loja_url 'categoria' categoria_slug=produto.categoria.slug %}">
 {{ produto.categoria.nome }}
 </a>
 </li>
 {% endif %}
 <li class="breadcrumb-item active" aria-current="page">{{ produto.nome }}</li>
 </ol>
 </nav>

 <div class="row">
 <!-- Imagem do produto -->
 <div class="col-lg-6 mb-4">
 <div class="card border-0 shadow-sm">
 {% if produto.imagem_principal %}
 <img src="{{ produto.imagem_principal.url }}" 
 class="card-img-top" 
 alt="{{ produto.nome }}"
 style="height: 400px; object-fit: cover;">
 {% else %}
 <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
 style="height: 400px;">
 <i class="bi bi-image fs-1 text-muted"></i>
 </div>
 {% endif %}
 </div>
 
 <!-- Imagens adicionais (se houver) -->
 {% if produto.imagens.exists %}
 <div class="row mt-3">
 {% for imagem in produto.imagens.all %}
 <div class="col-3">
 <img src="{{ imagem.imagem.url }}" 
 class="img-thumbnail" 
 alt="{{ produto.nome }}" 
 style="height: 80px; object-fit: cover; cursor: pointer;"
 onclick="document.querySelector('.card-img-top').src = this.src">
 </div>
 {% endfor %}
 </div>
 {% endif %}
 </div>

 <!-- Detalhes do produto -->
 <div class="col-lg-6">
 <div class="sticky-top" style="top: 100px;">
 <!-- T√≠tulo e pre√ßo -->
 <div class="mb-4">
 <h1 class="h2 mb-3">{{ produto.nome }}</h1>
 
 <!-- Categoria -->
 {% if produto.categoria %}
 <span class="badge bg-primary mb-3">{{ produto.categoria.nome }}</span>
 {% endif %}
 
 <!-- Pre√ßo -->
 <div class="mb-3">
 {% if produto.preco_promocional %}
 <span class="text-muted text-decoration-line-through me-2">
 R$ {{ produto.preco|floatformat:2 }}
 </span>
 <span class="h4 text-success fw-bold">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 {% else %}
 <span class="h4 text-primary fw-bold">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 {% endif %}
 </div>
 
 <!-- Descri√ß√£o -->
 <p class="lead text-muted">{{ produto.descricao }}</p>
 
 <!-- Informa√ß√µes adicionais -->
 {% if produto.tempo_preparo %}
 <div class="d-flex align-items-center mb-2">
 <i class="bi bi-clock me-2 text-muted"></i>
 <small class="text-muted">Tempo de preparo: {{ produto.tempo_preparo }} min</small>
 </div>
 {% endif %}
 
 {% if produto.calorias %}
 <div class="d-flex align-items-center mb-2">
 <i class="bi bi-activity me-2 text-muted"></i>
 <small class="text-muted">{{ produto.calorias }} kcal</small>
 </div>
 {% endif %}
 
 {% if produto.ingredientes %}
 <div class="mb-3">
 <strong class="d-block mb-1">Ingredientes:</strong>
 <small class="text-muted">{{ produto.ingredientes }}</small>
 </div>
 {% endif %}
 
 {% if produto.alergicos %}
 <div class="mb-3">
 <div class="alert alert-warning py-2">
 <i class="bi bi-exclamation-triangle me-2"></i>
 <small><strong>Al√©rgicos:</strong> {{ produto.alergicos }}</small>
 </div>
 </div>
 {% endif %}
 </div>

 <!-- Formul√°rio de personaliza√ß√£o -->
 <form id="produto-form" class="mb-4" method="POST" action="">
 {% csrf_token %}
 
   <!-- Bot√£o Meio-a-Meio Discreto (apenas para pizzas) -->
   {% if produto.permite_meio_a_meio and produto.categoria.nome == 'Pizzas' %}
   <div class="mb-3" id="meio-a-meio-section">
    <!-- Bot√£o discreto para ativar meio-a-meio -->
    <button type="button" 
            class="btn btn-outline-warning btn-sm me-2" 
            id="btn-meio-a-meio"
            onclick="ativarMeioAMeio()"
            style="border-radius: 20px;">
        <span style="font-size: 16px;">üçï</span> Quero meia pizza
    </button>
    
    <!-- Indicador quando meio-a-meio est√° ativo -->
    <div id="meio-a-meio-ativo" style="display: none;" class="mt-2">
        <div class="d-flex align-items-center">
            <span class="badge bg-warning text-dark me-2">
                <span style="font-size: 14px;">üçï</span> Meia Pizza
            </span>
            <small class="text-muted">
                Este sabor ser√° metade da sua pizza. Escolha outro sabor para completar!
            </small>
            <button type="button" 
                    class="btn btn-sm btn-link text-danger ms-auto p-0" 
                    onclick="cancelarMeioAMeio()"
                    title="Cancelar meia pizza">
                ‚úï
            </button>
        </div>
    </div>
   </div>
   {% endif %} <!-- Op√ß√µes de personaliza√ß√£o -->
 {% for opcao in opcoes_personalizacao %}
 <div class="card mb-3" data-opcao-id="{{ opcao.id }}" data-obrigatorio="{{ opcao.obrigatorio }}" 
 data-tipo="{{ opcao.tipo }}"
 {% if opcao.tipo == 'checkbox' %}data-min="{{ opcao.quantidade_minima|default:0 }}" data-max="{{ opcao.quantidade_maxima|default:'' }}"{% endif %}>
 <div class="card-body">
 <h6 class="card-title">
 {{ opcao.nome }}
 {% if opcao.obrigatorio %}
 <span class="text-danger">*</span>
 {% endif %}
 {% if opcao.tipo == 'checkbox' and opcao.quantidade_minima > 0 or opcao.quantidade_maxima %}
 <small class="text-muted">
 ({% if opcao.quantidade_minima > 0 %}Escolha no m√≠nimo {{ opcao.quantidade_minima }}{% endif %}
 {% if opcao.quantidade_maxima %}
 {% if opcao.quantidade_minima > 0 %} e no m√°ximo {% else %}Escolha no m√°ximo {% endif %}{{ opcao.quantidade_maxima }}
 {% endif %})
 </small>
 {% endif %}
 </h6>
 
 {% if opcao.tipo == 'radio' %}
 <!-- Sele√ß√£o √∫nica -->
 {% for item in opcao.itens.all %}
 <div class="form-check">
 <input class="form-check-input" 
 type="radio" 
 name="opcao_{{ opcao.id }}" 
 id="item_{{ item.id }}"
 value="{{ item.id }}"
 data-preco="{{ item.preco_adicional }}"
 {% if opcao.obrigatorio and forloop.first %}checked{% endif %}
 onchange="atualizarPreco()">
 <label class="form-check-label d-flex justify-content-between w-100" 
 for="item_{{ item.id }}">
 <span>{{ item.nome }}</span>
 {% if item.preco_adicional > 0 %}
 <span class="text-muted">+ R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% endif %}
 </label>
 </div>
 {% endfor %}
 
 {% elif opcao.tipo == 'checkbox' %}
 <!-- M√∫ltipla escolha -->
 {% for item in opcao.itens.all %}
 <div class="form-check">
 <input class="form-check-input" 
 type="checkbox" 
 name="opcao_{{ opcao.id }}[]" 
 id="item_{{ item.id }}"
 value="{{ item.id }}"
 data-preco="{{ item.preco_adicional }}"
 onchange="atualizarPreco(); validarQuantidade('{{ opcao.id }}')">
 <label class="form-check-label d-flex justify-content-between w-100" 
 for="item_{{ item.id }}">
 <span>{{ item.nome }}</span>
 {% if item.preco_adicional > 0 %}
 <span class="text-muted">+ R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% elif item.preco_adicional < 0 %}
 <span class="text-success">R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% endif %}
 </label>
 </div>
 {% endfor %}
 
 {% elif opcao.tipo == 'select' %}
 <!-- Lista suspensa -->
 <select class="form-select" 
 name="opcao_{{ opcao.id }}" 
 {% if opcao.obrigatorio %}required{% endif %}
 onchange="atualizarPreco()">
 {% if not opcao.obrigatorio %}
 <option value="">Selecione uma op√ß√£o</option>
 {% endif %}
 {% for item in opcao.itens.all %}
 <option value="{{ item.id }}" 
 data-preco="{{ item.preco_adicional }}"
 {% if opcao.obrigatorio and forloop.first %}selected{% endif %}>
 {{ item.nome }}
 {% if item.preco_adicional != 0 %}
 ({% if item.preco_adicional > 0 %}+{% endif %}R$ {{ item.preco_adicional|floatformat:2 }})
 {% endif %}
 </option>
 {% endfor %}
 </select>
 {% endif %}
 </div>
 </div>
 {% endfor %}

 <!-- Observa√ß√µes -->
 {% if produto.permite_observacoes %}
 <div class="mb-3">
 <label for="observacoes" class="form-label">Observa√ß√µes especiais</label>
 <textarea class="form-control" 
 id="observacoes" 
 name="observacoes" 
 rows="3" 
 placeholder="Alguma observa√ß√£o especial? (opcional)"></textarea>
 </div>
 {% endif %}

 <!-- Quantidade e adicionar ao carrinho -->
 <div class="row align-items-center">
 <div class="col-md-4">
 <label for="quantidade" class="form-label">Quantidade</label>
 <div class="input-group">
 <button class="btn btn-outline-secondary" type="button" onclick="alterarQuantidadeProduto(-1)">
 <i class="bi bi-dash"></i>
 </button>
 <input type="number" 
 class="form-control text-center" 
 id="quantidade" 
 name="quantidade" 
 value="1" 
 min="1" 
 max="99"
 onchange="atualizarPreco()">
 <button class="btn btn-outline-secondary" type="button" onclick="alterarQuantidadeProduto(1)">
 <i class="bi bi-plus"></i>
 </button>
 </div>
 </div>
 <div class="col-md-8">
 <label class="form-label">Total</label>
 <div class="d-flex align-items-center justify-content-between">
 <span class="h4 text-success fw-bold" id="preco-total">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 <button type="submit" class="btn btn-primary btn-lg">
 <i class="bi bi-cart-plus me-2"></i>
 Adicionar ao Carrinho
 </button>
 </div>
 </div>
 </div>
 </form>
 </div>
 </div>
 </div>

 <!-- Produtos relacionados -->
 {% if produtos_relacionados %}
 <div class="row mt-5">
 <div class="col-12">
 <h3 class="mb-4">Produtos Relacionados</h3>
 <div class="row">
 {% for produto_relacionado in produtos_relacionados %}
 <div class="col-md-6 col-lg-3 mb-4">
 <div class="card h-100 shadow-sm">
 {% if produto_relacionado.imagem_principal %}
 <img src="{{ produto_relacionado.imagem_principal.url }}" 
 class="card-img-top" 
 alt="{{ produto_relacionado.nome }}"
 style="height: 200px; object-fit: cover;">
 {% else %}
 <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
 style="height: 200px;">
 <i class="bi bi-image fs-3 text-muted"></i>
 </div>
 {% endif %}
 
 <div class="card-body d-flex flex-column">
 <h6 class="card-title">{{ produto_relacionado.nome }}</h6>
 <p class="card-text text-muted small flex-grow-1">
 {{ produto_relacionado.descricao|truncatewords:10 }}
 </p>
 <div class="d-flex justify-content-between align-items-center">
 <span class="text-primary fw-bold">
 R$ {{ produto_relacionado.preco_final|floatformat:2 }}
 </span>
 <a href="{% url 'loja:produto_detalhe' restaurante_slug=restaurante.slug produto_slug=produto_relacionado.slug %}" 
 class="btn btn-outline-primary btn-sm">Ver</a>
 </div>
 </div>
 </div>
 </div>
 {% endfor %}
 </div>
 </div>
 </div>
 {% endif %}
</div>

<!-- Toast de sucesso -->
<div class="toast-container position-fixed top-0 end-0 p-3">
 <div id="toast-sucesso" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
 <div class="toast-header">
 <i class="bi bi-check-circle text-success me-2"></i>
 <strong class="me-auto">Sucesso</strong>
 <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
 </div>
 <div class="toast-body">
 Produto adicionado ao carrinho!
 </div>
 </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üîß DEBUG: Base template script carregado');

// Dados do produto para JavaScript (definir primeiro)
window.produtoData = {
 id: '{{ produto.id|default:"" }}',
 nome: '{{ produto.nome|escapejs|default:"" }}',
 preco_base: parseFloat('{{ produto.preco_final|default:"0.00" }}') || 0.00,
 categoria: '{{ produto.categoria.nome|default:""|escapejs }}',
 imagem: '{% if produto.imagem_principal %}{{ produto.imagem_principal.url }}{% else %}{% endif %}'
};

// DEFINIR FUN√á√ïES GLOBALMENTE ANTES DE QUALQUER COISA
function atualizarPreco() {
 console.log('üí∞ Atualizando pre√ßo...');
 
 try {
 const precoBase = window.produtoData.preco_base;
 const quantidadeInput = document.getElementById('quantidade');
 const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) || 1 : 1;
 let precoAdicional = 0;
 
 console.log('üìä Pre√ßo base:', precoBase, 'Quantidade:', quantidade);
 
 // Somar pre√ßos adicionais das personaliza√ß√µes selecionadas
 const inputs = document.querySelectorAll('#produto-form input:checked, #produto-form select');
 console.log('üîß Inputs encontrados:', inputs.length);
 
 inputs.forEach(input => {
 let preco = 0;
 let precoRaw = '';
 
 if (input.type === 'checkbox' || input.type === 'radio') {
 precoRaw = input.dataset.preco || '0';
 preco = parseFloat(precoRaw.replace(',', '.'));
 } else if (input.tagName === 'SELECT') {
 const selectedOption = input.options[input.selectedIndex];
 precoRaw = selectedOption ? (selectedOption.dataset.preco || '0') : '0';
 preco = parseFloat(precoRaw.replace(',', '.'));
 }
 
 // console.log('üîß Debug pre√ßo:', {raw: precoRaw, parsed: preco, isNaN: isNaN(preco), value: input.value});
 
 if (!isNaN(preco) && preco !== 0) {
 precoAdicional += preco;
 console.log('üí∞ Adicionando pre√ßo:', preco, 'de', input.value || input.textContent);
 }
 });
 
 const precoTotal = (precoBase + precoAdicional) * quantidade;
 const precoElement = document.getElementById('preco-total');
 
 console.log('üí∞ C√°lculo final:', precoBase, '+', precoAdicional, '*', quantidade, '=', precoTotal);
 
 if (precoElement) {
 precoElement.textContent = `R$ ${precoTotal.toFixed(2).replace('.', ',')}`;
 console.log('‚úÖ Pre√ßo atualizado no DOM');
 } else {
 console.error('‚ùå Elemento preco-total n√£o encontrado');
 }
 } catch (error) {
 console.error('‚ùå Erro ao atualizar pre√ßo:', error);
 }
}

function alterarQuantidadeProduto(delta) {
 console.log('üî¢ Alterando quantidade do produto:', delta);
 
 const input = document.getElementById('quantidade');
 if (!input) {
 console.error('‚ùå Input de quantidade n√£o encontrado');
 return;
 }
 
 const quantidadeAtual = parseInt(input.value) || 1;
 const novaQuantidade = quantidadeAtual + delta;
 
 console.log('üî¢ Quantidade atual:', quantidadeAtual, '‚Üí Nova:', novaQuantidade);
 
 if (novaQuantidade >= 1 && novaQuantidade <= 99) {
 input.value = novaQuantidade;
 atualizarPreco();
 console.log('‚úÖ Quantidade alterada para:', novaQuantidade);
 } else {
 console.log('‚ö†Ô∏è Quantidade fora dos limites (1-99)');
 }
}

function validarQuantidade(opcaoId) {
 console.log('‚úÖ Validando quantidade para op√ß√£o:', opcaoId);
 
 const opcaoCard = document.querySelector(`[data-opcao-id="${opcaoId}"]`);
 if (!opcaoCard) {
 console.log('‚ùå Op√ß√£o n√£o encontrada:', opcaoId);
 return;
 }
 
 const tipo = opcaoCard.getAttribute('data-tipo');
 const min = parseInt(opcaoCard.getAttribute('data-min')) || 0;
 const max = parseInt(opcaoCard.getAttribute('data-max')) || 0;
 
 console.log('üìä Valida√ß√£o:', {tipo, min, max});
 
 if (tipo !== 'checkbox') {
 console.log('‚ÑπÔ∏è N√£o √© checkbox, pulando valida√ß√£o de quantidade');
 atualizarPreco(); 
 return;
 }
 
 const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]:checked`);
 const quantidadeSelecionada = selecionados.length;
 
 console.log(`üìä Op√ß√£o ${opcaoId}: ${quantidadeSelecionada}/${max} selecionados (m√≠n: ${min})`);
 
 // Limpar estilos anteriores
 opcaoCard.classList.remove('border-danger', 'border-warning', 'border-success', 'border-info');
 
 // Limpar estilos dos labels
 const todosCheckboxes = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]`);
 todosCheckboxes.forEach(checkbox => {
 const label = checkbox.closest('.form-check');
 if (label) {
 label.classList.remove('text-muted', 'opacity-50');
 checkbox.disabled = false;
 }
 });
 
 // Aplicar regras de limite m√°ximo
 if (max > 0 && quantidadeSelecionada >= max) {
 todosCheckboxes.forEach(checkbox => {
 if (!checkbox.checked) {
 checkbox.disabled = true;
 const label = checkbox.closest('.form-check');
 if (label) {
 label.classList.add('text-muted', 'opacity-50');
 }
 }
 });
 opcaoCard.classList.add('border-success');
 console.log('‚úÖ Limite m√°ximo atingido para op√ß√£o', opcaoId);
 } else if (min > 0 && quantidadeSelecionada < min) {
 opcaoCard.classList.add('border-warning');
 console.log('‚ö†Ô∏è Abaixo do m√≠nimo para op√ß√£o', opcaoId);
 } else if (quantidadeSelecionada > 0) {
 opcaoCard.classList.add('border-info');
 console.log('‚ÑπÔ∏è Sele√ß√£o v√°lida para op√ß√£o', opcaoId);
 }
 
 // Sempre atualizar o pre√ßo ap√≥s valida√ß√£o
 atualizarPreco();
}

// Disponibilizar as fun√ß√µes globalmente
window.atualizarPreco = atualizarPreco;
window.alterarQuantidadeProduto = alterarQuantidadeProduto;
window.validarQuantidade = validarQuantidade;

console.log('‚úÖ Fun√ß√µes definidas globalmente:', typeof atualizarPreco, typeof alterarQuantidadeProduto, typeof validarQuantidade);

// Teste das fun√ß√µes definidas
console.log('üß™ Testando fun√ß√µes:', typeof atualizarPreco, typeof alterarQuantidadeProduto, typeof validarQuantidade);

// Fun√ß√£o adicionarAoCarrinho ser√° usada do carrinho-novo.js

console.log('üîç SEARCH: Verificando fun√ß√µes globais:');
console.log('- adicionarAoCarrinho:', typeof window.adicionarAoCarrinho);
console.log('- atualizarContadorCarrinho:', typeof window.atualizarContadorCarrinho);
console.log('- mostrarToast:', typeof window.mostrarToast);
console.log('- carrinho:', typeof window.carrinho);

// Fun√ß√£o para adicionar ao carrinho
document.getElementById('produto-form').addEventListener('submit', function(e) {
 console.log(' Formul√°rio submetido - interceptando...');
 e.preventDefault();
 
 // Validar op√ß√µes obrigat√≥rias e quantidade
 let valid = true;
 let mensagemErro = '';
 const opcoes = document.querySelectorAll('[data-opcao-id]');
 
 opcoes.forEach(opcaoCard => {
 const opcaoId = opcaoCard.getAttribute('data-opcao-id');
 const obrigatorio = opcaoCard.getAttribute('data-obrigatorio') === 'True';
 const tipo = opcaoCard.getAttribute('data-tipo');
 const min = parseInt(opcaoCard.getAttribute('data-min')) || 0;
 const max = parseInt(opcaoCard.getAttribute('data-max')) || 0;
 
 const nomeOpcao = opcaoCard.querySelector('h6').textContent.trim();
 
 console.log(`üîç Validando op√ß√£o: ${nomeOpcao} | Tipo: ${tipo} | Obrigat√≥rio: ${obrigatorio}`);
 
 if (tipo === 'checkbox') {
 // Valida√ß√£o para checkbox com quantidade
 const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]:checked`);
 const quantidadeSelecionada = selecionados.length;
 
 if (obrigatorio && quantidadeSelecionada === 0) {
 valid = false;
 mensagemErro += `‚Ä¢ ${nomeOpcao} √© obrigat√≥rio\n`;
 opcaoCard.classList.add('border-danger');
 } else if (min > 0 && quantidadeSelecionada < min) {
 valid = false;
 mensagemErro += `‚Ä¢ ${nomeOpcao}: selecione pelo menos ${min} op√ß√µes\n`;
 opcaoCard.classList.add('border-warning');
 } else if (max > 0 && quantidadeSelecionada > max) {
 valid = false;
 mensagemErro += `‚Ä¢ ${nomeOpcao}: selecione no m√°ximo ${max} op√ß√µes\n`;
 opcaoCard.classList.add('border-warning');
 } else {
 opcaoCard.classList.remove('border-danger', 'border-warning');
 }
 } else {
 // Valida√ß√£o para radio/select
 let temSelecao = false;
 
 if (tipo === 'select') {
     // Para select, verificar se tem valor selecionado
     const selectElement = document.querySelector(`select[name="opcao_${opcaoId}"]`);
     console.log(`üîç Select encontrado:`, selectElement, `Valor:`, selectElement?.value);
     if (selectElement && selectElement.value !== '') {
         temSelecao = true;
     }
 } else {
     // Para radio buttons
     const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}"]:checked`);
     console.log(`üîç Radio buttons selecionados:`, selecionados.length);
     temSelecao = selecionados.length > 0;
 }
 
 console.log(`üîç ${nomeOpcao} - Tem sele√ß√£o: ${temSelecao}, Obrigat√≥rio: ${obrigatorio}`);
 
 if (obrigatorio && !temSelecao) {
 valid = false;
 mensagemErro += `‚Ä¢ ${nomeOpcao} √© obrigat√≥rio\n`;
 opcaoCard.classList.add('border-danger');
 console.log(`‚ùå ${nomeOpcao} falhou na valida√ß√£o`);
 } else {
 opcaoCard.classList.remove('border-danger');
 console.log(`‚úÖ ${nomeOpcao} passou na valida√ß√£o`);
 }
 }
 });
 
 if (!valid) {
 alert('Por favor, corrija os seguintes problemas:\n\n' + mensagemErro);
 return;
 }
 
 // Coletar dados do formul√°rio
 const formData = new FormData(this);
 const quantidade = parseInt(formData.get('quantidade'));
 const observacoes = formData.get('observacoes') || '';
 
 // Coletar personaliza√ß√µes
 const personalizacoes = [];
 
 // Coletar inputs checked (radio buttons e checkboxes)
 const inputsChecked = document.querySelectorAll('#produto-form input:checked');
 inputsChecked.forEach(input => {
 if (input.value && input.value !== '') {
 personalizacoes.push({
 opcao_id: input.name.replace('opcao_', '').replace('[]', ''),
 item_id: input.value,
 nome: input.labels?.[0]?.textContent?.split('+')[0]?.trim() || input.textContent?.trim(),
 preco_adicional: parseFloat(input.dataset.preco || 0)
 });
 }
 });
 
 // Coletar selects com valor selecionado
 const selects = document.querySelectorAll('#produto-form select');
 selects.forEach(select => {
 if (select.value && select.value !== '') {
 const selectedOption = select.options[select.selectedIndex];
 personalizacoes.push({
 opcao_id: select.name.replace('opcao_', '').replace('[]', ''),
 item_id: select.value,
 nome: selectedOption.text.split('(')[0].trim(),
 preco_adicional: parseFloat(selectedOption.dataset.preco || 0)
 });
 }
 });
 
 // Calcular pre√ßo final
 const precoBase = window.produtoData.preco_base;
 const precoAdicional = personalizacoes.reduce((total, p) => total + p.preco_adicional, 0);
 let precoUnitario = precoBase + precoAdicional;
 
 // Verificar se √© completa√ß√£o de meio-a-meio
 const completandoMeioAMeio = localStorage.getItem('meioAMeio_ativo') === 'true';
 let nomeCompletoItem = window.produtoData.nome;
 
 if (completandoMeioAMeio && primeiroSabor) {
     // Calcular pre√ßo baseado no sabor mais caro
     const precoSegundoSabor = precoUnitario;
     const precoPrimeiroSabor = primeiroSabor.preco;
     precoUnitario = Math.max(precoPrimeiroSabor, precoSegundoSabor);
     
     // Nome especial para pizza meio-a-meio
     nomeCompletoItem = `Pizza Meio-a-Meio: ${primeiroSabor.nome} / {{ produto.nome }}`;
     
     // ID especial para pizza meio-a-meio (combinar os dois IDs)
     const idMeioAMeio = `meio-${primeiroSabor.id}-${window.produtoData.id}`;
     
     console.log('üçï Completando meio-a-meio:', {
         primeiroSabor: primeiroSabor.nome,
         segundoSabor: '{{ produto.nome }}',
         precoFinal: precoUnitario,
         idMeioAMeio: idMeioAMeio
     });
     
     // Dados especiais para pizza meio-a-meio
     const itemCarrinho = {
         produto_id: idMeioAMeio, // ID √∫nico para meio-a-meio
         quantidade: quantidade,
         nome: nomeCompletoItem,
         preco_unitario: precoUnitario,
         meio_a_meio: {
             primeiro_sabor: primeiroSabor,
             segundo_sabor: {
                 id: '{{ produto.id }}',
                 nome: '{{ produto.nome }}',
                 preco: precoBase
             }
         },
         personalizacoes: personalizacoes,
         observacoes: observacoes || ''
     };
     
     console.log('üì¶ Item meio-a-meio preparado:', itemCarrinho);
     
     // Adicionar ao carrinho e limpar localStorage
     if (typeof window.adicionarAoCarrinho === 'function') {
         adicionarAoCarrinho(itemCarrinho);
         
         // Limpar localStorage
         localStorage.removeItem('meioAMeio_ativo');
         localStorage.removeItem('meioAMeio_primeiroSabor');
         console.log('üçï Meio-a-meio completado e localStorage limpo');
         
         // Mostrar toast especial
         if (typeof window.mostrarToast === 'function') {
             mostrarToast('üçï Pizza meio-a-meio adicionada ao carrinho!', 'success');
         }
         
         // Mostrar bot√£o continuar comprando
         setTimeout(() => {
             mostrarBotaoContinuarComprando();
         }, 500);
     }
     
     return; // Interromper aqui para n√£o adicionar pizza normal
 }
 
 // Se chegou aqui, √© uma pizza normal (n√£o meio-a-meio)
 // Dados do item para o carrinho (formato compat√≠vel com Django view)
 const itemCarrinho = {
 produto_id: window.produtoData.id,
 quantidade: quantidade,
 personalizacoes: personalizacoes,  // Usar personalizacoes completas
 observacoes: observacoes || ''
 };
 
 console.log('üì¶ Item preparado para carrinho:', itemCarrinho);
 console.log('üì¶ JSON stringified:', JSON.stringify(itemCarrinho, null, 2));
 
 // Adicionar ao carrinho (pizza normal)
 if (typeof window.adicionarAoCarrinho === 'function') {
     adicionarAoCarrinho(itemCarrinho);
     
     // Mostrar bot√£o continuar comprando ap√≥s adicionar (se n√£o for meio-a-meio ativo)
     if (!meioAMeioAtivo) {
         setTimeout(() => {
             mostrarBotaoContinuarComprando();
         }, 500); // Pequeno delay para dar feedback visual
     }
 } else {
     console.error('‚ùå Fun√ß√£o adicionarAoCarrinho n√£o encontrada');
     alert('Erro: sistema de carrinho n√£o carregado');
 }
 
 // Resetar formulario (opcional)
 // this.reset();
 // atualizarPreco();
});

// Inicializar sistema quando p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
 console.log('üöÄ Inicializando sistema de produto...');
 
 // Atualizar pre√ßo inicial
 setTimeout(function() {
 atualizarPreco();
 }, 100);
 
 // Adicionar eventos de mudan√ßa para todos os inputs de personaliza√ß√£o
 const personalizacaoInputs = document.querySelectorAll('#produto-form input, #produto-form select');
 console.log('üîß Configurando eventos para', personalizacaoInputs.length, 'inputs');
 
 personalizacaoInputs.forEach(function(input) {
 // Evento para atualizar pre√ßo quando algo muda
 input.addEventListener('change', function() {
 console.log('üîÑ Input alterado:', input.name, input.value);
 
 // Se for checkbox de op√ß√£o, validar quantidade
 if (input.type === 'checkbox' && input.name.startsWith('opcao_')) {
 const opcaoId = input.name.replace('opcao_', '').replace('[]', '');
 validarQuantidade(opcaoId);
 } else {
 // Para outros tipos, apenas atualizar pre√ßo
 atualizarPreco();
 }
 });
 });
 
 // Evento para input de quantidade
 const quantidadeInput = document.getElementById('quantidade');
 if (quantidadeInput) {
 quantidadeInput.addEventListener('input', function() {
 atualizarPreco();
 });
 }
 
 console.log('‚úÖ Sistema de produto inicializado');
});

// ===== SISTEMA MEIO-A-MEIO =====
let meioAMeioAtivo = false;
let primeiroSabor = null;

// Ativar modo meio-a-meio
window.ativarMeioAMeio = function() {
    meioAMeioAtivo = true;
    
    // Esconder bot√£o e mostrar indicador
    document.getElementById('btn-meio-a-meio').style.display = 'none';
    document.getElementById('meio-a-meio-ativo').style.display = 'block';
    
    // Salvar dados do produto atual como primeiro sabor
    primeiroSabor = {
        id: '{{ produto.id }}',
        nome: '{{ produto.nome }}',
        preco: parseFloat('{{ produto.preco }}'),
        slug: '{{ produto.slug }}'
    };
    
    console.log('üçï Modo meio-a-meio ativado. Primeiro sabor:', primeiroSabor);
    
    // Salvar no localStorage para persisitir entre p√°ginas
    localStorage.setItem('meioAMeio_ativo', 'true');
    localStorage.setItem('meioAMeio_primeiroSabor', JSON.stringify(primeiroSabor));
    
    // Mostrar bot√£o continuar comprando
    mostrarBotaoContinuarComprando();
};

// Cancelar modo meio-a-meio
window.cancelarMeioAMeio = function() {
    meioAMeioAtivo = false;
    primeiroSabor = null;
    
    // Mostrar bot√£o e esconder indicador
    document.getElementById('btn-meio-a-meio').style.display = 'inline-block';
    document.getElementById('meio-a-meio-ativo').style.display = 'none';
    
    // Limpar localStorage
    localStorage.removeItem('meioAMeio_ativo');
    localStorage.removeItem('meioAMeio_primeiroSabor');
    
    // Esconder bot√£o continuar comprando
    esconderBotaoContinuarComprando();
    
    console.log('üçï Modo meio-a-meio cancelado');
};

// ===== BOT√ÉO CONTINUAR COMPRANDO =====
function mostrarBotaoContinuarComprando() {
    const botao = document.getElementById('continuar-comprando-btn');
    if (botao) {
        botao.classList.remove('d-none');
    }
}

function esconderBotaoContinuarComprando() {
    const botao = document.getElementById('continuar-comprando-btn');
    if (botao) {
        botao.classList.add('d-none');
    }
}

// Fun√ß√£o para continuar comprando
window.continuarComprando = function() {
    if (meioAMeioAtivo && primeiroSabor) {
        // Salvar no localStorage para usar na pr√≥xima p√°gina
        localStorage.setItem('meioAMeio_primeiroSabor', JSON.stringify(primeiroSabor));
        localStorage.setItem('meioAMeio_ativo', 'true');
    }
    
    // Ir para o card√°pio
    window.location.href = '{% loja_url "cardapio" %}';
};

// Verificar se chegamos de um meio-a-meio ativo
document.addEventListener('DOMContentLoaded', function() {
    const meioAMeioSalvo = localStorage.getItem('meioAMeio_ativo');
    const primeiroSaborSalvo = localStorage.getItem('meioAMeio_primeiroSabor');
    
    if (meioAMeioSalvo === 'true' && primeiroSaborSalvo && '{{ produto.categoria.nome }}' === 'Pizzas') {
        // Se chegamos aqui com meio-a-meio ativo, este √© o segundo sabor
        primeiroSabor = JSON.parse(primeiroSaborSalvo);
        
        // Mostrar aviso de que est√° completando meio-a-meio
        const avisoDiv = document.createElement('div');
        avisoDiv.className = 'alert alert-success mb-3';
        avisoDiv.innerHTML = `
            <strong>üçï Completando sua pizza meio-a-meio!</strong><br>
            <small>1¬∫ Sabor: ${primeiroSabor.nome} | 2¬∫ Sabor: {{ produto.nome }}</small>
        `;
        
        // Inserir antes do formul√°rio
        const form = document.getElementById('produto-form');
        form.parentNode.insertBefore(avisoDiv, form);
        
        // localStorage ser√° limpo ap√≥s adicionar ao carrinho
    }
});

// Fun√ß√£o para controlar meio-a-meio (manter compatibilidade)
window.toggleMeioAMeio = function() {
    // Esta fun√ß√£o foi substitu√≠da pelas novas fun√ß√µes acima
    console.log('Fun√ß√£o toggleMeioAMeio() foi substitu√≠da');
};

</script>

<!-- Bot√£o Flutuante "Continuar Comprando" -->
<div id="continuar-comprando-btn" 
     class="position-fixed d-none btn-flutuante" 
     style="bottom: 20px; right: 20px;">
    <button type="button" 
            class="btn btn-primary rounded-circle shadow-lg"
            onclick="continuarComprando()"
            style="width: 60px; height: 60px; font-size: 24px;"
            title="Continuar Comprando">
        üõí
    </button>
    <div class="mt-2 text-center">
        <small class="text-muted bg-white px-2 py-1 rounded shadow-sm">
            Continuar Comprando
        </small>
    </div>
</div>

{% endblock %}