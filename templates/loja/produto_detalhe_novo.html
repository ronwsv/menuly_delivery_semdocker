{% extends "base.html" %}
{% load static %}
{% load loja_extras %}

{% block title %}{{ produto.nome }} - {{ restaurante.nome }}{% endblock %}

{% block extra_head %}
<meta property="og:title" content="{{ produto.nome }} - {{ restaurante.nome }}">
<meta property="og:description" content="{{ produto.descricao }}">
{% if produto.imagem_principal %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ produto.imagem_principal.url }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container py-4">
 <!-- Breadcrumb -->
 <nav aria-label="breadcrumb" class="mb-4">
 <ol class="breadcrumb">
 <li class="breadcrumb-item"><a href="{% loja_url 'home' %}">Início</a></li>
 <li class="breadcrumb-item"><a href="{% loja_url 'cardapio' %}">Cardápio</a></li>
 {% if produto.categoria %}
 <li class="breadcrumb-item">
 <a href="{% loja_url 'categoria' categoria_slug=produto.categoria.slug %}">
 {{ produto.categoria.nome }}
 </a>
 </li>
 {% endif %}
 <li class="breadcrumb-item active" aria-current="page">{{ produto.nome }}</li>
 </ol>
 </nav>

 <div class="row">
 <!-- Imagem do produto -->
 <div class="col-lg-6 mb-4">
 <div class="card border-0 shadow-sm">
 {% if produto.imagem_principal %}
 <img src="{{ produto.imagem_principal.url }}" 
 class="card-img-top" 
 alt="{{ produto.nome }}"
 style="height: 400px; object-fit: cover;">
 {% else %}
 <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
 style="height: 400px;">
 <i class="bi bi-image fs-1 text-muted"></i>
 </div>
 {% endif %}
 </div>
 
 <!-- Imagens adicionais (se houver) -->
 {% if produto.imagens.exists %}
 <div class="row mt-3">
 {% for imagem in produto.imagens.all %}
 <div class="col-3">
 <img src="{{ imagem.imagem.url }}" 
 class="img-thumbnail" 
 alt="{{ produto.nome }}" 
 style="height: 80px; object-fit: cover; cursor: pointer;"
 onclick="document.querySelector('.card-img-top').src = this.src">
 </div>
 {% endfor %}
 </div>
 {% endif %}
 </div>

 <!-- Detalhes do produto -->
 <div class="col-lg-6">
 <div class="sticky-top" style="top: 100px;">
 <!-- Título e preço -->
 <div class="mb-4">
 <h1 class="h2 mb-3">{{ produto.nome }}</h1>
 
 <!-- Categoria -->
 {% if produto.categoria %}
 <span class="badge bg-primary mb-3">{{ produto.categoria.nome }}</span>
 {% endif %}
 
 <!-- Preço -->
 <div class="mb-3">
 {% if produto.preco_promocional %}
 <span class="text-muted text-decoration-line-through me-2">
 R$ {{ produto.preco|floatformat:2 }}
 </span>
 <span class="h4 text-success fw-bold">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 {% else %}
 <span class="h4 text-primary fw-bold">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 {% endif %}
 </div>
 
 <!-- Descrição -->
 <p class="lead text-muted">{{ produto.descricao }}</p>
 
 <!-- Informações adicionais -->
 {% if produto.tempo_preparo %}
 <div class="d-flex align-items-center mb-2">
 <i class="bi bi-clock me-2 text-muted"></i>
 <small class="text-muted">Tempo de preparo: {{ produto.tempo_preparo }} min</small>
 </div>
 {% endif %}
 
 {% if produto.calorias %}
 <div class="d-flex align-items-center mb-2">
 <i class="bi bi-activity me-2 text-muted"></i>
 <small class="text-muted">{{ produto.calorias }} kcal</small>
 </div>
 {% endif %}
 
 {% if produto.ingredientes %}
 <div class="mb-3">
 <strong class="d-block mb-1">Ingredientes:</strong>
 <small class="text-muted">{{ produto.ingredientes }}</small>
 </div>
 {% endif %}
 
 {% if produto.alergicos %}
 <div class="mb-3">
 <div class="alert alert-warning py-2">
 <i class="bi bi-exclamation-triangle me-2"></i>
 <small><strong>Alérgicos:</strong> {{ produto.alergicos }}</small>
 </div>
 </div>
 {% endif %}
 </div>

 <!-- Formulário de personalização -->
 <form id="produto-form" class="mb-4" method="POST" action="">
 {% csrf_token %}
 
 <!-- Opções de personalização -->
 {% for opcao in opcoes_personalizacao %}
 <div class="card mb-3" data-opcao-id="{{ opcao.id }}" data-obrigatorio="{{ opcao.obrigatorio }}" 
 {% if opcao.tipo == 'checkbox' %}data-tipo="checkbox" data-min="{{ opcao.quantidade_minima|default:0 }}" data-max="{{ opcao.quantidade_maxima|default:'' }}"{% endif %}>
 <div class="card-body">
 <h6 class="card-title">
 {{ opcao.nome }}
 {% if opcao.obrigatorio %}
 <span class="text-danger">*</span>
 {% endif %}
 {% if opcao.tipo == 'checkbox' and opcao.quantidade_minima > 0 or opcao.quantidade_maxima %}
 <small class="text-muted">
 ({% if opcao.quantidade_minima > 0 %}Escolha no mínimo {{ opcao.quantidade_minima }}{% endif %}
 {% if opcao.quantidade_maxima %}
 {% if opcao.quantidade_minima > 0 %} e no máximo {% else %}Escolha no máximo {% endif %}{{ opcao.quantidade_maxima }}
 {% endif %})
 </small>
 {% endif %}
 </h6>
 
 {% if opcao.tipo == 'radio' %}
 <!-- Seleção única -->
 {% for item in opcao.itens.all %}
 <div class="form-check">
 <input class="form-check-input" 
 type="radio" 
 name="opcao_{{ opcao.id }}" 
 id="item_{{ item.id }}"
 value="{{ item.id }}"
 data-preco="{{ item.preco_adicional }}"
 {% if opcao.obrigatorio and forloop.first %}checked{% endif %}
 onchange="atualizarPreco()">
 <label class="form-check-label d-flex justify-content-between w-100" 
 for="item_{{ item.id }}">
 <span>{{ item.nome }}</span>
 {% if item.preco_adicional > 0 %}
 <span class="text-muted">+ R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% endif %}
 </label>
 </div>
 {% endfor %}
 
 {% elif opcao.tipo == 'checkbox' %}
 <!-- Múltipla escolha -->
 {% for item in opcao.itens.all %}
 <div class="form-check">
 <input class="form-check-input" 
 type="checkbox" 
 name="opcao_{{ opcao.id }}[]" 
 id="item_{{ item.id }}"
 value="{{ item.id }}"
 data-preco="{{ item.preco_adicional }}"
 onchange="atualizarPreco(); validarQuantidade('{{ opcao.id }}')">
 <label class="form-check-label d-flex justify-content-between w-100" 
 for="item_{{ item.id }}">
 <span>{{ item.nome }}</span>
 {% if item.preco_adicional > 0 %}
 <span class="text-muted">+ R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% elif item.preco_adicional < 0 %}
 <span class="text-success">R$ {{ item.preco_adicional|floatformat:2 }}</span>
 {% endif %}
 </label>
 </div>
 {% endfor %}
 
 {% elif opcao.tipo == 'select' %}
 <!-- Lista suspensa -->
 <select class="form-select" 
 name="opcao_{{ opcao.id }}" 
 {% if opcao.obrigatorio %}required{% endif %}
 onchange="atualizarPreco()">
 {% if not opcao.obrigatorio %}
 <option value="">Selecione uma opção</option>
 {% endif %}
 {% for item in opcao.itens.all %}
 <option value="{{ item.id }}" 
 data-preco="{{ item.preco_adicional }}"
 {% if opcao.obrigatorio and forloop.first %}selected{% endif %}>
 {{ item.nome }}
 {% if item.preco_adicional != 0 %}
 ({% if item.preco_adicional > 0 %}+{% endif %}R$ {{ item.preco_adicional|floatformat:2 }})
 {% endif %}
 </option>
 {% endfor %}
 </select>
 {% endif %}
 </div>
 </div>
 {% endfor %}

 <!-- Observações -->
 {% if produto.permite_observacoes %}
 <div class="mb-3">
 <label for="observacoes" class="form-label">Observações especiais</label>
 <textarea class="form-control" 
 id="observacoes" 
 name="observacoes" 
 rows="3" 
 placeholder="Alguma observação especial? (opcional)"></textarea>
 </div>
 {% endif %}

 <!-- Quantidade e adicionar ao carrinho -->
 <div class="row align-items-center">
 <div class="col-md-4">
 <label for="quantidade" class="form-label">Quantidade</label>
 <div class="input-group">
 <button class="btn btn-outline-secondary" type="button" onclick="alterarQuantidadeProduto(-1)">
 <i class="bi bi-dash"></i>
 </button>
 <input type="number" 
 class="form-control text-center" 
 id="quantidade" 
 name="quantidade" 
 value="1" 
 min="1" 
 max="99"
 onchange="atualizarPreco()">
 <button class="btn btn-outline-secondary" type="button" onclick="alterarQuantidadeProduto(1)">
 <i class="bi bi-plus"></i>
 </button>
 </div>
 </div>
 <div class="col-md-8">
 <label class="form-label">Total</label>
 <div class="d-flex align-items-center justify-content-between">
 <span class="h4 text-success fw-bold" id="preco-total">
 R$ {{ produto.preco_final|floatformat:2 }}
 </span>
 <button type="submit" class="btn btn-primary btn-lg">
 <i class="bi bi-cart-plus me-2"></i>
 Adicionar ao Carrinho
 </button>
 </div>
 </div>
 </div>
 </form>
 </div>
 </div>
 </div>

 <!-- Produtos relacionados -->
 {% if produtos_relacionados %}
 <div class="row mt-5">
 <div class="col-12">
 <h3 class="mb-4">Produtos Relacionados</h3>
 <div class="row">
 {% for produto_relacionado in produtos_relacionados %}
 <div class="col-md-6 col-lg-3 mb-4">
 <div class="card h-100 shadow-sm">
 {% if produto_relacionado.imagem_principal %}
 <img src="{{ produto_relacionado.imagem_principal.url }}" 
 class="card-img-top" 
 alt="{{ produto_relacionado.nome }}"
 style="height: 200px; object-fit: cover;">
 {% else %}
 <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
 style="height: 200px;">
 <i class="bi bi-image fs-3 text-muted"></i>
 </div>
 {% endif %}
 
 <div class="card-body d-flex flex-column">
 <h6 class="card-title">{{ produto_relacionado.nome }}</h6>
 <p class="card-text text-muted small flex-grow-1">
 {{ produto_relacionado.descricao|truncatewords:10 }}
 </p>
 <div class="d-flex justify-content-between align-items-center">
 <span class="text-primary fw-bold">
 R$ {{ produto_relacionado.preco_final|floatformat:2 }}
 </span>
 <a href="{% url 'loja:produto_detalhe' restaurante_slug=restaurante.slug produto_slug=produto_relacionado.slug %}" 
 class="btn btn-outline-primary btn-sm">Ver</a>
 </div>
 </div>
 </div>
 </div>
 {% endfor %}
 </div>
 </div>
 </div>
 {% endif %}
</div>

<!-- Toast de sucesso -->
<div class="toast-container position-fixed top-0 end-0 p-3">
 <div id="toast-sucesso" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
 <div class="toast-header">
 <i class="bi bi-check-circle text-success me-2"></i>
 <strong class="me-auto">Sucesso</strong>
 <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
 </div>
 <div class="toast-body">
 Produto adicionado ao carrinho!
 </div>
 </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('🔧 DEBUG: Base template script carregado');

// Dados do produto para JavaScript (definir primeiro)
window.produtoData = {
 id: {{ produto.id|default:0 }},
 nome: '{{ produto.nome|escapejs }}',
 preco_base: parseFloat('{{ produto.preco_final|default:0 }}') || 0,
 categoria: '{{ produto.categoria.nome|default:""|escapejs }}',
 imagem: '{% if produto.imagem_principal %}{{ produto.imagem_principal.url }}{% else %}{% endif %}'
};

// Implementações COMPLETAS das funções (não temporárias!)
window.atualizarPreco = function() {
 console.log('💰 Atualizando preço...');
 
 try {
 const precoBase = window.produtoData.preco_base;
 const quantidadeInput = document.getElementById('quantidade');
 const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) || 1 : 1;
 let precoAdicional = 0;
 
 console.log('📊 Preço base:', precoBase, 'Quantidade:', quantidade);
 
 // Somar preços adicionais das personalizações selecionadas
 const inputs = document.querySelectorAll('#produto-form input:checked, #produto-form select');
 console.log('🔧 Inputs encontrados:', inputs.length);
 
 inputs.forEach(input => {
 let preco = 0;
 
 if (input.type === 'checkbox' || input.type === 'radio') {
 preco = parseFloat(input.dataset.preco || 0);
 } else if (input.tagName === 'SELECT') {
 const selectedOption = input.options[input.selectedIndex];
 preco = selectedOption ? parseFloat(selectedOption.dataset.preco || 0) : 0;
 }
 
 if (!isNaN(preco) && preco > 0) {
 precoAdicional += preco;
 console.log('💰 Adicionando preço:', preco, 'de', input.value || input.textContent);
 }
 });
 
 const precoTotal = (precoBase + precoAdicional) * quantidade;
 const precoElement = document.getElementById('preco-total');
 
 console.log('💰 Cálculo final:', precoBase, '+', precoAdicional, '*', quantidade, '=', precoTotal);
 
 if (precoElement) {
 precoElement.textContent = `R$ ${precoTotal.toFixed(2).replace('.', ',')}`;
 console.log('✅ Preço atualizado no DOM');
 } else {
 console.error('❌ Elemento preco-total não encontrado');
 }
 } catch (error) {
 console.error('❌ Erro ao atualizar preço:', error);
 }
};
console.log('✅ atualizarPreco definida em', new Date().toISOString());

window.alterarQuantidadeProduto = function(delta) {
 console.log('🔢 Alterando quantidade do produto:', delta);
 
 const input = document.getElementById('quantidade');
 if (!input) {
 console.error('❌ Input de quantidade não encontrado');
 return;
 }
 
 const quantidadeAtual = parseInt(input.value) || 1;
 const novaQuantidade = quantidadeAtual + delta;
 
 console.log('🔢 Quantidade atual:', quantidadeAtual, '→ Nova:', novaQuantidade);
 
 if (novaQuantidade >= 1 && novaQuantidade <= 99) {
 input.value = novaQuantidade;
 atualizarPreco();
 console.log('✅ Quantidade alterada para:', novaQuantidade);
 } else {
 console.log('⚠️ Quantidade fora dos limites (1-99)');
 }
};
console.log('✅ alterarQuantidadeProduto definida em', new Date().toISOString());

window.validarQuantidade = function(opcaoId) {
 console.log('✅ Validando quantidade para opção:', opcaoId);
 
 const opcaoCard = document.querySelector(`[data-opcao-id="${opcaoId}"]`);
 if (!opcaoCard) {
 console.log('❌ Opção não encontrada:', opcaoId);
 return;
 }
 
 const tipo = opcaoCard.getAttribute('data-tipo');
 const min = parseInt(opcaoCard.getAttribute('data-min')) || 0;
 const max = parseInt(opcaoCard.getAttribute('data-max')) || 0;
 
 console.log('📊 Validação:', {tipo, min, max});
 
 if (tipo !== 'checkbox') {
 console.log('ℹ️ Não é checkbox, pulando validação de quantidade');
 atualizarPreco(); // Ainda atualiza o preço
 return;
 }
 
 const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]:checked`);
 const quantidadeSelecionada = selecionados.length;
 
 console.log(`📊 Opção ${opcaoId}: ${quantidadeSelecionada}/${max} selecionados (mín: ${min})`);
 
 // Limpar estilos anteriores
 opcaoCard.classList.remove('border-danger', 'border-warning', 'border-success', 'border-info');
 
 // Limpar estilos dos labels
 const todosCheckboxes = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]`);
 todosCheckboxes.forEach(checkbox => {
 const label = checkbox.closest('.form-check');
 if (label) {
 label.classList.remove('text-muted', 'opacity-50');
 checkbox.disabled = false;
 }
 });
 
 // Aplicar regras de limite máximo
 if (max > 0 && quantidadeSelecionada >= max) {
 // Desabilitar checkboxes não selecionados
 todosCheckboxes.forEach(checkbox => {
 if (!checkbox.checked) {
 checkbox.disabled = true;
 const label = checkbox.closest('.form-check');
 if (label) {
 label.classList.add('text-muted', 'opacity-50');
 }
 }
 });
 opcaoCard.classList.add('border-success');
 console.log('✅ Limite máximo atingido para opção', opcaoId);
 } else if (min > 0 && quantidadeSelecionada < min) {
 opcaoCard.classList.add('border-warning');
 console.log('⚠️ Abaixo do mínimo para opção', opcaoId);
 } else if (quantidadeSelecionada > 0) {
 opcaoCard.classList.add('border-info');
 console.log('ℹ️ Seleção válida para opção', opcaoId);
 }
 
 // Sempre atualizar o preço após validação
 atualizarPreco();
};
console.log('✅ validarQuantidade definida em', new Date().toISOString());

// Teste imediato das funções
console.log('🧪 Testando funções imediatamente...');
console.log('🧪 typeof atualizarPreco:', typeof window.atualizarPreco);
console.log('🧪 typeof alterarQuantidadeProduto:', typeof window.alterarQuantidadeProduto);
console.log('🧪 typeof validarQuantidade:', typeof window.validarQuantidade);

// Aguardar DOM e re-testar
document.addEventListener('DOMContentLoaded', function() {
 console.log('🏁 DOM carregado, re-testando funções...');
 console.log('🧪 typeof atualizarPreco:', typeof window.atualizarPreco);
 console.log('🧪 typeof alterarQuantidadeProduto:', typeof window.alterarQuantidadeProduto);
 console.log('🧪 typeof validarQuantidade:', typeof window.validarQuantidade);
 
 // Testar acesso direto
 if (typeof window.atualizarPreco === 'function') {
 console.log('✅ atualizarPreco acessível via window');
 } else {
 console.error('❌ atualizarPreco NÃO acessível via window');
 }
});

// Implementação completa da função adicionarAoCarrinho
window.adicionarAoCarrinho = function(item) {
    console.log('🛒 adicionarAoCarrinho chamada (template):', item);
    
    // Obter slug do restaurante da URL atual
    var currentPath = window.location.pathname;
    var slugMatch = currentPath.match(/^\/([^\/]+)\//);
    
    if (!slugMatch) {
        console.error('❌ Slug do restaurante não encontrado na URL');
        alert('Erro: não foi possível identificar o restaurante');
        return;
    }
    
    var restauranteSlug = slugMatch[1];
    var url = '/' + restauranteSlug + '/carrinho/adicionar/';
    
    // Obter CSRF token
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('❌ CSRF token não encontrado');
        alert('Erro: token de segurança não encontrado');
        return;
    }
    
    // Enviar para o backend
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify(item)
    })
    .then(function(response) {
        console.log('📡 Resposta recebida:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        console.log('📦 Dados da resposta:', data);
        if (data.success) {
            // Atualizar contador do carrinho se a função existe
            if (typeof atualizarContadorCarrinho === 'function') {
                atualizarContadorCarrinho();
            }
            
            // Mostrar toast de sucesso
            if (typeof mostrarToast === 'function') {
                mostrarToast('Produto adicionado ao carrinho!', 'success');
            }
            
            // Mostrar toast do Bootstrap se existe
            if (typeof bootstrap !== 'undefined') {
                var toastEl = document.getElementById('toast-sucesso');
                if (toastEl) {
                    var toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
            } else {
                // Fallback para alert
                alert('Produto adicionado ao carrinho!');
            }
            
        } else {
            console.error('❌ Erro no servidor:', data.error);
            alert('Erro: ' + (data.error || 'Falha ao adicionar produto.'));
        }
    })
    .catch(function(error) {
        console.error('❌ Erro na requisição:', error);
        alert('Erro ao adicionar produto ao carrinho');
    });
};

console.log('🔍 SEARCH: Verificando funções globais:');
console.log('- adicionarAoCarrinho:', typeof window.adicionarAoCarrinho);
console.log('- atualizarContadorCarrinho:', typeof window.atualizarContadorCarrinho);
console.log('- mostrarToast:', typeof window.mostrarToast);
console.log('- carrinho:', typeof window.carrinho);

// Função para adicionar ao carrinho
document.getElementById('produto-form').addEventListener('submit', function(e) {
 console.log(' Formulário submetido - interceptando...');
 e.preventDefault();
 
 // Validar opções obrigatórias e quantidade
 let valid = true;
 let mensagemErro = '';
 const opcoes = document.querySelectorAll('[data-opcao-id]');
 
 opcoes.forEach(opcaoCard => {
 const opcaoId = opcaoCard.getAttribute('data-opcao-id');
 const obrigatorio = opcaoCard.getAttribute('data-obrigatorio') === 'True';
 const tipo = opcaoCard.getAttribute('data-tipo');
 const min = parseInt(opcaoCard.getAttribute('data-min')) || 0;
 const max = parseInt(opcaoCard.getAttribute('data-max')) || 0;
 
 const nomeOpcao = opcaoCard.querySelector('h6').textContent.trim();
 
 if (tipo === 'checkbox') {
 // Validação para checkbox com quantidade
 const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}[]"]:checked`);
 const quantidadeSelecionada = selecionados.length;
 
 if (obrigatorio && quantidadeSelecionada === 0) {
 valid = false;
 mensagemErro += `• ${nomeOpcao} é obrigatório\n`;
 opcaoCard.classList.add('border-danger');
 } else if (min > 0 && quantidadeSelecionada < min) {
 valid = false;
 mensagemErro += `• ${nomeOpcao}: selecione pelo menos ${min} opções\n`;
 opcaoCard.classList.add('border-warning');
 } else if (max > 0 && quantidadeSelecionada > max) {
 valid = false;
 mensagemErro += `• ${nomeOpcao}: selecione no máximo ${max} opções\n`;
 opcaoCard.classList.add('border-warning');
 } else {
 opcaoCard.classList.remove('border-danger', 'border-warning');
 }
 } else {
 // Validação para radio/select
 const selecionados = document.querySelectorAll(`[name="opcao_${opcaoId}"]:checked`);
 
 if (obrigatorio && selecionados.length === 0) {
 valid = false;
 mensagemErro += `• ${nomeOpcao} é obrigatório\n`;
 opcaoCard.classList.add('border-danger');
 } else {
 opcaoCard.classList.remove('border-danger');
 }
 }
 });
 
 if (!valid) {
 alert('Por favor, corrija os seguintes problemas:\n\n' + mensagemErro);
 return;
 }
 
 // Coletar dados do formulário
 const formData = new FormData(this);
 const quantidade = parseInt(formData.get('quantidade'));
 const observacoes = formData.get('observacoes') || '';
 
 // Coletar personalizações
 const personalizacoes = [];
 const inputs = document.querySelectorAll('#produto-form input:checked, #produto-form select');
 
 inputs.forEach(input => {
 if (input.value && input.value !== '') {
 personalizacoes.push({
 opcao_id: input.name.replace('opcao_', '').replace('[]', ''),
 item_id: input.value,
 nome: input.labels?.[0]?.textContent?.split('+')[0]?.trim() || input.options?.[input.selectedIndex]?.text?.split('(')[0]?.trim(),
 preco_adicional: parseFloat(input.dataset.preco || input.options?.[input.selectedIndex]?.dataset?.preco || 0)
 });
 }
 });
 
 // Calcular preço final
 const precoBase = window.produtoData.preco_base;
 const precoAdicional = personalizacoes.reduce((total, p) => total + p.preco_adicional, 0);
 const precoUnitario = precoBase + precoAdicional;
 
 // Dados do item para o carrinho
 const itemCarrinho = {
 produto_id: window.produtoData.id,
 nome: window.produtoData.nome,
 categoria: window.produtoData.categoria,
 preco: precoUnitario,
 quantidade: quantidade,
 personalizacoes: personalizacoes,
 observacoes: observacoes,
 imagem: window.produtoData.imagem
 };
 
 // Adicionar ao carrinho
 adicionarAoCarrinho(itemCarrinho);
 
 // Mostrar toast de sucesso
 const toast = new bootstrap.Toast(document.getElementById('toast-sucesso'));
 toast.show();
 
 // Resetar formulario (opcional)
 // this.reset();
 // atualizarPreco();
});

// Inicializar sistema quando página carrega
document.addEventListener('DOMContentLoaded', function() {
 console.log('🚀 Inicializando sistema de produto...');
 
 // Atualizar preço inicial
 setTimeout(function() {
 atualizarPreco();
 }, 100);
 
 // Adicionar eventos de mudança para todos os inputs de personalização
 const personalizacaoInputs = document.querySelectorAll('#produto-form input, #produto-form select');
 console.log('🔧 Configurando eventos para', personalizacaoInputs.length, 'inputs');
 
 personalizacaoInputs.forEach(function(input) {
 // Evento para atualizar preço quando algo muda
 input.addEventListener('change', function() {
 console.log('🔄 Input alterado:', input.name, input.value);
 
 // Se for checkbox de opção, validar quantidade
 if (input.type === 'checkbox' && input.name.startsWith('opcao_')) {
 const opcaoId = input.name.replace('opcao_', '').replace('[]', '');
 validarQuantidade(opcaoId);
 } else {
 // Para outros tipos, apenas atualizar preço
 atualizarPreco();
 }
 });
 });
 
 // Evento para input de quantidade
 const quantidadeInput = document.getElementById('quantidade');
 if (quantidadeInput) {
 quantidadeInput.addEventListener('input', function() {
 atualizarPreco();
 });
 }
 
 console.log('✅ Sistema de produto inicializado');
});
</script>
{% endblock %}