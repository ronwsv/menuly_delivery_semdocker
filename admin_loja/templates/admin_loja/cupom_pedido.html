<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cupom de Produção - Pedido {{ pedido.numero }}</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background: #fff; color: #222; }
        .cupom {
            width: 340px;
            margin: 24px auto;
            background: #fff;
            border: 1px dashed #222;
            padding: 18px 18px 8px 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0002;
        }
        .cupom h2, .cupom h3 { text-align: center; margin: 0 0 8px 0; }
        .cupom .linha { border-bottom: 1px dashed #222; margin: 8px 0; }
        .cupom .senha {
            text-align: center;
            font-size: 1.2em;
            margin: 12px 0 8px 0;
            font-weight: bold;
            background: yellow;
            color: #222;
            padding: 4px 0;
            border-radius: 4px;
            letter-spacing: 2px;
        }
        .cupom .imprimir { display: block; margin: 16px auto 0 auto; padding: 8px 24px; font-size: 1em; background: #222; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .cupom .itens td { font-size: 1em; padding: 2px 0; }
        .cupom .itens th { text-align: left; }
    </style>
</head>
<body>
    <div class="cupom">
        {% if pedido.status == 'pronto' or pedido.status == 'entrega' %}
            <div style="text-align:center;font-size:1.1em;">Entrega</div>
            <div style="text-align:center;font-size:1em; margin-bottom:6px;">
                <b>Pedido Nº Original:</b> <span style="font-size:1.1em;">{{ pedido.numero }}</span><br>
                {{ pedido.created_at|date:'d/m/y H:i' }}
            </div>
            <div class="senha">* Cod. Pers./Senha: {{ pedido.numero|slice:'-4:-1' }} *</div>
            <div style="margin:8px 0;">Cliente: {{ pedido.cliente_nome }}</div>
            <div style="margin-bottom:8px;">Endereço: {{ pedido.endereco_logradouro }}, {{ pedido.endereco_numero }} {{ pedido.endereco_complemento }}<br>{{ pedido.endereco_bairro }} - {{ pedido.endereco_cidade }} / {{ pedido.endereco_estado }}<br>CEP: {{ pedido.endereco_cep }}</div>
            <div style="margin-bottom:8px;"><b>Produtos para entrega:</b></div>
            <table class="itens" style="width:100%;margin-bottom:8px;">
                <tbody>
                    {% for item in itens %}
                    <tr>
                        <td style="font-weight: bold;">{% if item.meio_a_meio %}1/2x {% endif %}{% if item.quantidade > 1 %}{{ item.quantidade }}x {% endif %}{{ item.produto_nome }}</td>
                    </tr>
                    {% if item.personalizacoes.exists %}
                        {% regroup item.personalizacoes.all by opcao_nome as opcoes_agrupadas %}
                        {% for opcao_grupo in opcoes_agrupadas %}
                        <tr>
                            <td style="padding-left: 8px; font-size: 0.85em; color: #666;">{{ opcao_grupo.grouper }}:</td>
                        </tr>
                        {% for personalizacao in opcao_grupo.list %}
                        <tr>
                            <td style="padding-left: 15px; font-size: 0.9em;">• {{ personalizacao.item_nome }}{% if personalizacao.preco_adicional > 0 %} (+R$ {{ personalizacao.preco_adicional|floatformat:2 }}){% endif %}</td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    {% endif %}
                    {% if item.observacoes %}
                    <tr>
                        <td style="padding-left: 10px; font-size: 0.9em; font-style: italic;">Obs: {{ item.observacoes }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <div style="margin-bottom:8px;">Forma de pagamento: <b>{{ pedido.get_forma_pagamento_display }}</b></div>
            <div style="margin-bottom:8px;">Valor total: <b>R$ {{ pedido.total|floatformat:2 }}</b></div>
            {% if pedido.forma_pagamento == 'dinheiro' and pedido.troco_para %}
                <div style="margin-bottom:8px;">Troco para: <b>R$ {{ pedido.troco_para|floatformat:2 }}</b></div>
            {% endif %}
            {% if pedido.forma_pagamento in 'cartao_credito,cartao_debito,pix,online' %}
                <div style="margin-bottom:8px;">Levar maquininha: <b>Sim</b></div>
            {% endif %}
            {% if pedido.observacoes %}<div style="margin-bottom:8px;"><b>Obs:</b> {{ pedido.observacoes }}</div>{% endif %}
            <div class="linha"></div>
            <div style="text-align:center;font-size:0.95em;">Menuly</div>
            <button class="imprimir" onclick="window.print()">Imprimir</button>
        {% else %}
            <div style="text-align:center;font-size:1.1em;">Cozinha principal</div>
            <div style="text-align:center;font-size:1em; margin-bottom:6px;">{{ pedido.created_at|date:'d/m/y H:i' }} Pedido Nº: {{ pedido.numero }}</div>
            <div class="senha">* Cod. Pers./Senha: {{ pedido.numero|slice:'-4:-1' }} *</div>
            <div style="margin:8px 0;">{{ pedido.cliente_nome }}</div>
            <table class="itens" style="width:100%;margin-bottom:8px;">
                <tbody>
                    {% for item in itens %}
                    <tr>
                        <td style="font-weight: bold;">{% if item.meio_a_meio %}1/2x {% endif %}{% if item.quantidade > 1 %}{{ item.quantidade }}x {% endif %}{{ item.produto_nome }} | Cod {{ forloop.counter0 }}</td>
                    </tr>
                    {% if item.personalizacoes.exists %}
                        {% regroup item.personalizacoes.all by opcao_nome as opcoes_agrupadas %}
                        {% for opcao_grupo in opcoes_agrupadas %}
                        <tr>
                            <td style="padding-left: 8px; font-size: 0.85em; color: #666;">{{ opcao_grupo.grouper }}:</td>
                        </tr>
                        {% for personalizacao in opcao_grupo.list %}
                        <tr>
                            <td style="padding-left: 15px; font-size: 0.9em;">• {{ personalizacao.item_nome }}{% if personalizacao.preco_adicional > 0 %} (+R$ {{ personalizacao.preco_adicional|floatformat:2 }}){% endif %}</td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    {% endif %}
                    {% if item.observacoes %}
                    <tr>
                        <td style="padding-left: 10px; font-size: 0.9em; font-style: italic;">Obs: {{ item.observacoes }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% if pedido.observacoes %}<div style="margin-bottom:8px;"><b>Obs:</b> {{ pedido.observacoes }}</div>{% endif %}
            <div style="margin-bottom:8px;">Atendente do Pedido: {{ pedido.cliente.get_full_name|default:pedido.cliente.username|default:'---' }}</div>
            <div class="linha"></div>
            <div style="text-align:center;font-size:0.95em;">Menuly</div>
            <button class="imprimir" onclick="window.print()">Imprimir</button>
        {% endif %}
    </div>
</body>
</html>
